---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Physical Science Module 9 Quiz">
    <div class="container">
        <h1>Physical Science Module 9 Quiz</h1>
        
        <div class="email-input" id="email-section">
            <label for="email">Enter your email (optional):</label>
            <input type="email" id="email" placeholder="your.email@example.com">
            <div>
                <input type="checkbox" id="save-results" checked>
                <label for="save-results">Save results and send to instructor</label>
            </div>
            <button class="control-button" id="start-quiz">Start Quiz</button>
        </div>

        <div id="quiz-container" style="display: none;">
            <div class="progress-bar">
                <div class="fill"></div>
            </div>
            <div id="question-number"></div>
            <div id="question-text"></div>
            <div class="options"></div>
            <div id="feedback" class="feedback"></div>
            <div class="controls">
                <button id="prevBtn" class="control-button" onclick="previousQuestion()">Previous Question</button>
                <button id="nextBtn" class="control-button" onclick="nextQuestion()">Next Question</button>
                <button id="submitBtn" class="control-button" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
            </div>
        </div>

        <div id="results" style="display: none;">
            <h2>Quiz Results</h2>
            <div id="score"></div>
            <div id="email-status" class="email-status"></div>
            <div id="incorrect-answers"></div>
            <div class="result-buttons">
                <button id="download-results" class="control-button">Download Results</button>
                <button id="restart-quiz" class="control-button" onclick="window.location.reload()">Restart Quiz</button>
            </div>
        </div>
    </div>
</Layout>

<style>
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    .question {
        margin-bottom: 20px;
    }
    #question-number {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 15px;
    }
    #question-text {
        font-size: 16px;
        margin-bottom: 20px;
    }
    .options {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .option-button {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
    }
    .option-button:hover {
        background: #f5f5f5;
    }
    .option-button.selected {
        background: #e0e0e0;
    }
    .option-button.correct {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    .option-button.incorrect {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    .feedback {
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
        display: none;
    }
    .feedback.correct {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        display: block;
    }
    .feedback.incorrect {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        display: block;
    }
    .controls {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }
    .control-button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background: #007bff;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
    }
    .control-button:hover {
        background: #0056b3;
    }
    .control-button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    .progress-bar {
        width: 100%;
        height: 10px;
        background: #f0f0f0;
        border-radius: 5px;
        margin: 20px 0;
        overflow: hidden;
    }
    .progress-bar .fill {
        height: 100%;
        background: #007bff;
        width: 0;
        transition: width 0.3s ease;
    }
    .email-status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
        display: none;
    }
    .email-status.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    .email-status.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    .result-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }
    .wrong-answer {
        color: #721c24;
    }
    .right-answer {
        color: #155724;
        font-weight: bold;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js" is:inline></script>
<script is:inline>
    // Quiz questions
    window.questions = [
        {
            question: "What is the definition of a solution?",
            options: [
                "A mixture that has different properties from its components",
                "A homogeneous mixture with uniform properties throughout",
                "A heterogeneous mixture with varying properties",
                "A mixture that can be easily separated"
            ],
            correctAnswer: 1,
            explanation: "A solution is a homogeneous mixture that has uniform properties throughout its entire volume."
        },
        // ... existing questions remain unchanged ...
    ];

    // Quiz state
    window.currentQuestion = 0;
    window.userAnswers = new Array(window.questions.length).fill(null);
    window.questionAttempts = new Array(window.questions.length).fill(0);
    window.userEmail = '';
    window.saveResults = true;

    function startQuiz() {
        const email = document.getElementById('email').value;
        const saveResults = document.getElementById('save-results').checked;
        window.userEmail = email;
        window.saveResults = saveResults;
        
        document.getElementById('email-section').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'block';
        
        showQuestion();
        updateProgressBar();
    }

    function showQuestion() {
        const questionNumber = document.getElementById('question-number');
        const questionText = document.getElementById('question-text');
        const options = document.querySelector('.options');
        const feedback = document.getElementById('feedback');
        
        questionNumber.textContent = `Question ${window.currentQuestion + 1} of ${window.questions.length}`;
        questionText.textContent = window.questions[window.currentQuestion].question;
        
        // Clear previous options and feedback
        options.innerHTML = '';
        feedback.className = 'feedback';
        feedback.textContent = '';
        
        // Create option buttons
        window.questions[window.currentQuestion].options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.textContent = option;
            button.onclick = () => selectAnswer(index);
            options.appendChild(button);
        });
        
        // Update navigation buttons
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        prevBtn.style.display = window.currentQuestion > 0 ? 'block' : 'none';
        nextBtn.style.display = window.currentQuestion < window.questions.length - 1 ? 'block' : 'none';
        submitBtn.style.display = window.currentQuestion === window.questions.length - 1 ? 'block' : 'none';
        
        // If this question was already answered, show the previous answer
        if (window.userAnswers[window.currentQuestion] !== undefined) {
            const options = document.querySelectorAll('.option-button');
            const selectedOption = options[window.userAnswers[window.currentQuestion]];
            if (selectedOption) {
                selectedOption.classList.add('selected');
                if (window.userAnswers[window.currentQuestion] === window.questions[window.currentQuestion].correctAnswer) {
                    selectedOption.classList.add('correct');
                    feedback.className = 'feedback correct';
                    feedback.textContent = window.questions[window.currentQuestion].explanation;
                }
            }
        }
    }

    function selectAnswer(selectedIndex) {
        const options = document.querySelectorAll('.option-button');
        const feedback = document.getElementById('feedback');
        const currentQuestion = window.questions[window.currentQuestion];
        
        // Only allow selection if not already answered correctly
        if (window.userAnswers[window.currentQuestion] !== currentQuestion.correctAnswer) {
            window.questionAttempts[window.currentQuestion]++;
            
            // Clear previous selection
            options.forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Mark new selection
            options[selectedIndex].classList.add('selected');
            
            // Check if answer is correct
            if (selectedIndex === currentQuestion.correctAnswer) {
                options[selectedIndex].classList.add('correct');
                feedback.className = 'feedback correct';
                feedback.textContent = currentQuestion.explanation;
                window.userAnswers[window.currentQuestion] = selectedIndex;
            } else {
                options[selectedIndex].classList.add('incorrect');
                feedback.className = 'feedback incorrect';
                feedback.textContent = "Incorrect. Try again.";
                
                // If max attempts reached, show correct answer
                if (window.questionAttempts[window.currentQuestion] >= 2) {
                    options[currentQuestion.correctAnswer].classList.add('correct');
                    feedback.textContent = currentQuestion.explanation;
                    window.userAnswers[window.currentQuestion] = selectedIndex; // Store the last attempt
                }
            }
        }
        
        updateProgressBar();
    }

    function previousQuestion() {
        if (window.currentQuestion > 0) {
            window.currentQuestion--;
            showQuestion();
        }
    }

    function nextQuestion() {
        if (window.currentQuestion < window.questions.length - 1) {
            window.currentQuestion++;
            showQuestion();
        }
    }

    function updateProgressBar() {
        const progressBar = document.querySelector('.progress-bar .fill');
        if (progressBar) {
            const progress = ((window.currentQuestion + 1) / window.questions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }
    }

    function submitQuiz() {
        const score = window.userAnswers.reduce((total, answer, index) => {
            return total + (answer === window.questions[index].correctAnswer ? 1 : 0);
        }, 0);

        const quizContainer = document.getElementById('quiz-container');
        const resultsDiv = document.getElementById('results');
        const scoreDiv = document.getElementById('score');
        const incorrectAnswersDiv = document.getElementById('incorrect-answers');
        
        quizContainer.style.display = 'none';
        resultsDiv.style.display = 'block';
        
        const percentage = (score / window.questions.length) * 100;
        scoreDiv.textContent = `Your score: ${score}/${window.questions.length} (${percentage.toFixed(1)}%)`;
        
        // Show incorrect answers
        incorrectAnswersDiv.innerHTML = '';
        window.userAnswers.forEach((answer, index) => {
            if (answer !== window.questions[index].correctAnswer) {
                const questionDiv = document.createElement('div');
                questionDiv.innerHTML = `
                    <p><strong>Question ${index + 1}:</strong> ${window.questions[index].question}</p>
                    <p class="wrong-answer">Your answer: ${window.questions[index].options[answer]}</p>
                    <p class="right-answer">Correct answer: ${window.questions[index].options[window.questions[index].correctAnswer]}</p>
                `;
                incorrectAnswersDiv.appendChild(questionDiv);
            }
        });

        // Send results via EmailJS if enabled
        if (window.saveResults && window.userEmail) {
            emailjs.init("la6DVzxI7W2gVEkX6");
            
            const templateParams = {
                user_email: window.userEmail,
                quiz_name: "Module 9 Quiz",
                score: `${score}/${window.questions.length}`,
                percentage: percentage.toFixed(1) + "%"
            };

            emailjs.send("service_ot1jg6s", "template_v678xjf", templateParams)
                .then(() => {
                    const emailStatus = document.getElementById('email-status');
                    emailStatus.textContent = "Results sent successfully!";
                    emailStatus.className = "email-status success";
                    emailStatus.style.display = "block";
                })
                .catch(() => {
                    const emailStatus = document.getElementById('email-status');
                    emailStatus.textContent = "Failed to send results. Please try again.";
                    emailStatus.className = "email-status error";
                    emailStatus.style.display = "block";
                });
        }
    }

    // Add download results functionality
    document.getElementById('download-results').addEventListener('click', function() {
        const score = window.userAnswers.reduce((total, answer, index) => {
            return total + (answer === window.questions[index].correctAnswer ? 1 : 0);
        }, 0);
        
        const percentage = (score / window.questions.length) * 100;
        
        let resultsText = `Module 9 Quiz Results\n\n`;
        resultsText += `Score: ${score}/${window.questions.length} (${percentage.toFixed(1)}%)\n\n`;
        
        window.questions.forEach((question, index) => {
            resultsText += `Question ${index + 1}: ${question.question}\n`;
            resultsText += `Your answer: ${question.options[window.userAnswers[index]]}\n`;
            resultsText += `Correct answer: ${question.options[question.correctAnswer]}\n`;
            resultsText += `${window.userAnswers[index] === question.correctAnswer ? "✓ Correct" : "✗ Incorrect"}\n\n`;
        });
        
        const blob = new Blob([resultsText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'module9_quiz_results.txt';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    });

    // Add event listener for start quiz button
    document.getElementById('start-quiz').addEventListener('click', startQuiz);
</script>

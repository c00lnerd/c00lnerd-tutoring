<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 3 Quiz - Atomic Structure and the Periodic Table</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            // Initialize EmailJS with your public key
            emailjs.init('la6DVzxI7W2gVEkX6');
        })();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            line-height: 1.6;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .feedback.incorrect {
            color: #dc3545;
            font-weight: bold;
        }

        .result-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }

        #email-container {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .email-input-group {
            margin: 20px 0;
        }

        .option-row {
            margin-bottom: 15px;
        }

        .checkbox-group {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        #student-email {
            padding: 12px 15px;
            width: 300px;
            margin-right: 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        #student-email:focus {
            outline: none;
            border-color: #4caf50;
        }

        .control-button {
            padding: 12px 25px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .control-button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }

        .control-button:disabled {
            background-color: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        #quiz-container {
            display: none;
        }

        .question {
            margin-bottom: 30px;
        }

        .question h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .question p {
            color: #34495e;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-button {
            padding: 12px;
            background-color: #fff;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            font-size: 1em;
            transition: all 0.2s;
        }

        .option-button:hover {
            border-color: #4caf50;
            background-color: #f8f9fa;
        }

        .option-button.selected {
            border-color: #4caf50;
            background-color: #e8f5e9;
        }

        .feedback {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .correct {
            color: #137333;
            background-color: #e6f4ea;
        }

        .incorrect {
            color: #d93025;
            background-color: #fce8e6;
        }

        .atom-builder {
            margin-top: 20px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .atom-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .atom-controls div {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .atom-controls label {
            min-width: 160px;
            color: #2c3e50;
            font-weight: 500;
        }

        .atom-controls input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            width: 100px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .atom-controls input:focus {
            outline: none;
            border-color: #4caf50;
        }

        .results {
            display: none;
        }

        .incorrect-answers {
            list-style: none;
            padding: 0;
        }

        .review-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .download-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #34a853;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 20px;
        }

        .download-button:hover {
            background-color: #2d8a46;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Module 3 Quiz - Physical Science</h1>

        <div id="email-container" class="email-container">
            <h2>Quiz Options</h2>
            <div class="email-input-group">
                <div class="option-row">
                    <input type="email" id="email" placeholder="Enter your email (optional)">
                    <div class="checkbox-group">
                        <input type="checkbox" id="save-results" checked>
                        <label for="save-results">Save results and send to instructor</label>
                    </div>
                </div>
                <button id="start-button" class="control-button">Start Quiz</button>
            </div>
            <div id="error" class="error-message" style="display: none;"></div>
        </div>

        <div id="quiz-container" class="quiz-container" style="display: none;">
            <div id="question-container"></div>
            <div class="controls">
                <button id="submit-button" class="control-button" style="display: none;">Submit Answer</button>
                <button id="next-button" class="control-button" style="display: none;">Next Question</button>
            </div>
        </div>

        <div id="results" class="results" style="display: none;">
            <h2>Quiz Results</h2>
            <div id="score"></div>
            <div id="email-status" style="margin: 10px 0; display: none;"></div>
            <div id="incorrect-answers"></div>
            <div class="result-actions">
                <button id="download-results" class="control-button">Download Results</button>
                <button id="restart-quiz" class="control-button">Restart Quiz</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize DOM elements
            const emailContainer = document.getElementById('email-container');
            const quizContainer = document.getElementById('quiz-container');
            const errorDiv = document.getElementById('error');
            const emailInput = document.getElementById('email');
            const startButton = document.getElementById('start-button');
            const submitButton = document.getElementById('submit-button');
            const nextButton = document.getElementById('next-button');
            const questionContainer = document.getElementById('question-container');
            const resultsDiv = document.getElementById('results');
            const scoreDiv = document.getElementById('score');

            // Quiz state
            const state = {
                studentEmail: '',
                currentQuestion: 0,
                score: 0,
                answered: false,
                selectedAnswer: null,
                incorrectAnswers: [],
                shuffledOptions: {}
            };

            // Quiz questions array
            const questions = [
                {
                    question: "What is the atomic number of an element?",
                    type: "multiple-choice",
                    options: [
                        "The number of protons in the nucleus",
                        "The number of neutrons in the nucleus",
                        "The total number of protons and neutrons",
                        "The number of electron shells"
                    ],
                    correctAnswer: "The number of protons in the nucleus"
                },
                {
                    question: "Which subatomic particle has a negative charge?",
                    type: "multiple-choice",
                    options: [
                        "Proton",
                        "Neutron",
                        "Electron",
                        "Nucleus"
                    ],
                    correctAnswer: "Electron"
                },
                {
                    question: "What is the mass number of an atom?",
                    type: "multiple-choice",
                    options: [
                        "The number of protons only",
                        "The number of neutrons only",
                        "The sum of protons and neutrons",
                        "The sum of protons and electrons"
                    ],
                    correctAnswer: "The sum of protons and neutrons"
                },
                {
                    question: "What is an isotope?",
                    type: "multiple-choice",
                    options: [
                        "Atoms with different numbers of protons",
                        "Atoms with different numbers of neutrons but same number of protons",
                        "Atoms with different numbers of electrons",
                        "Atoms with no neutrons"
                    ],
                    correctAnswer: "Atoms with different numbers of neutrons but same number of protons"
                },
                {
                    question: "Build a neutral carbon atom:",
                    type: "atom-builder",
                    correctAnswer: {
                        protons: 6,
                        neutrons: 6,
                        electrons: 6
                    }
                },
                {
                    question: "What determines the chemical properties of an element?",
                    type: "multiple-choice",
                    options: [
                        "The number of neutrons",
                        "The number of protons",
                        "The total number of nucleons",
                        "The mass number"
                    ],
                    correctAnswer: "The number of protons"
                },
                {
                    question: "Build a neutral sodium atom:",
                    type: "atom-builder",
                    correctAnswer: {
                        protons: 11,
                        neutrons: 12,
                        electrons: 11
                    }
                },
                {
                    question: "What is the charge of a proton?",
                    type: "multiple-choice",
                    options: [
                        "+1",
                        "-1",
                        "0",
                        "+2"
                    ],
                    correctAnswer: "+1"
                },
                {
                    question: "What is the charge of a neutron?",
                    type: "multiple-choice",
                    options: [
                        "+1",
                        "-1",
                        "0",
                        "+2"
                    ],
                    correctAnswer: "0"
                },
                {
                    question: "Build a neutral magnesium atom:",
                    type: "atom-builder",
                    correctAnswer: {
                        protons: 12,
                        neutrons: 12,
                        electrons: 12
                    }
                },
                {
                    question: "What happens to an atom when it gains electrons?",
                    type: "multiple-choice",
                    options: [
                        "It becomes a positive ion",
                        "It becomes a negative ion",
                        "It remains neutral",
                        "It becomes an isotope"
                    ],
                    correctAnswer: "It becomes a negative ion"
                },
                {
                    question: "What is the atomic mass unit (amu) approximately equal to?",
                    type: "multiple-choice",
                    options: [
                        "The mass of a proton",
                        "The mass of an electron",
                        "The mass of a neutron",
                        "The total mass of protons and neutrons"
                    ],
                    correctAnswer: "The total mass of protons and neutrons"
                },
                {
                    question: "Build a neutral aluminum atom:",
                    type: "atom-builder",
                    correctAnswer: {
                        protons: 13,
                        neutrons: 14,
                        electrons: 13
                    }
                },
                {
                    question: "What is the main difference between atomic number and mass number?",
                    type: "multiple-choice",
                    options: [
                        "Atomic number counts only neutrons, mass number counts all particles",
                        "Atomic number counts only protons, mass number counts protons and neutrons",
                        "Atomic number counts protons and electrons, mass number counts only neutrons",
                        "Atomic number counts all particles, mass number counts only protons"
                    ],
                    correctAnswer: "Atomic number counts only protons, mass number counts protons and neutrons"
                },
                {
                    question: "What makes an atom electrically neutral?",
                    type: "multiple-choice",
                    options: [
                        "Having equal numbers of protons and neutrons",
                        "Having equal numbers of protons and electrons",
                        "Having more protons than electrons",
                        "Having more electrons than protons"
                    ],
                    correctAnswer: "Having equal numbers of protons and electrons"
                },
                {
                    question: "Build a neutral oxygen atom:",
                    type: "atom-builder",
                    correctAnswer: {
                        protons: 8,
                        neutrons: 8,
                        electrons: 8
                    }
                },
                {
                    question: "Where are electrons found in an atom?",
                    type: "multiple-choice",
                    options: [
                        "Only in the nucleus",
                        "In electron shells around the nucleus",
                        "Randomly distributed throughout the atom",
                        "Between the protons in the nucleus"
                    ],
                    correctAnswer: "In electron shells around the nucleus"
                },
                {
                    question: "What happens to an atom when it loses electrons?",
                    type: "multiple-choice",
                    options: [
                        "It becomes a positive ion",
                        "It becomes a negative ion",
                        "It remains neutral",
                        "It becomes an isotope"
                    ],
                    correctAnswer: "It becomes a positive ion"
                },
                {
                    question: "Build a neutral nitrogen atom:",
                    type: "atom-builder",
                    correctAnswer: {
                        protons: 7,
                        neutrons: 7,
                        electrons: 7
                    }
                },
                {
                    question: "Which particle has the least mass?",
                    type: "multiple-choice",
                    options: [
                        "Proton",
                        "Neutron",
                        "Electron",
                        "They all have the same mass"
                    ],
                    correctAnswer: "Electron"
                },
                {
                    question: "Build a neutral atom of Helium (He)",
                    type: "atom-builder",
                    correctAnswer: {
                        protons: 2,
                        neutrons: 2,
                        electrons: 2
                    }
                },
                {
                    question: "What is the mass number of an atom?",
                    type: "multiple-choice",
                    options: [
                        "The number of protons only",
                        "The number of neutrons only",
                        "The sum of protons and electrons",
                        "The sum of protons and neutrons"
                    ],
                    correctAnswer: "The sum of protons and neutrons"
                },
                {
                    question: "Build a neutral atom of Lithium (Li)",
                    type: "atom-builder",
                    correctAnswer: {
                        protons: 3,
                        neutrons: 4,
                        electrons: 3
                    }
                },
                {
                    type: 'multiple-choice',
                    question: "What was Aristotle's view on the composition of matter?",
                    options: [
                        'Matter was made of atoms',
                        'Matter was made of four elements: earth, air, fire, and water',
                        'Matter was made of molecules',
                        'Matter was made of quarks'
                    ],
                    correctAnswer: 'Matter was made of four elements: earth, air, fire, and water',
                    reference: 'Aristotle believed all matter was composed of four elements: earth, air, fire, and water.'
                },
                {
                    type: 'multiple-choice',
                    question: 'Match these scientists with their atomic model contributions:',
                    options: [
                        'Thomson - Discovered electrons and proposed the plum pudding model',
                        'Rutherford - Proposed the nuclear model of the atom',
                        'Bohr - Proposed electrons orbit the nucleus in specific energy levels',
                        'All of the above'
                    ],
                    correctAnswer: 'All of the above',
                    reference: 'Each scientist made significant contributions to our understanding of atomic structure:',
                    details: [
                        { term: 'J.J. Thomson', definition: 'Discovered electrons in 1897 and proposed the plum pudding model' },
                        { term: 'Ernest Rutherford', definition: 'Discovered the nucleus in 1911 and proposed the nuclear model' },
                        { term: 'Niels Bohr', definition: 'Proposed that electrons orbit in specific energy levels in 1913' },
                        { term: 'James Chadwick', definition: 'Discovered the neutron in 1932' }
                    ]
                },
                {
                    type: 'multiple-choice',
                    question: "Which law states that matter cannot be created or destroyed, but can change forms?",
                    options: [
                        'Law of Conservation of Mass',
                        'Law of Definite Proportions',
                        'Law of Multiple Proportions',
                        'Law of Conservation of Energy'
                    ],
                    correctAnswer: 'Law of Conservation of Mass',
                    reference: 'The Law of Conservation of Mass states that matter cannot be created or destroyed in a chemical reaction.'
                },
                {
                    type: 'multiple-choice',
                    question: "Calculate the mass number of an oxygen atom with 8 protons and 10 neutrons:",
                    options: [
                        '8',
                        '10',
                        '18',
                        '28'
                    ],
                    correctAnswer: '18',
                    reference: 'Mass number = number of protons + number of neutrons'
                }
            ];

            // Utility function to shuffle array
            const shuffle = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            // Display current question
            const displayQuestion = () => {
                const question = questions[state.currentQuestion];
                let html = '';

                // Question header
                html += '<div class="question">';
                html += `<h2>Question ${state.currentQuestion + 1} of ${questions.length}</h2>`;
                html += `<p>${question.question}</p>`;
                html += '</div>';
                html += '<div id="feedback" class="feedback"></div>';

                // Question content based on type
                switch (question.type) {
                    case 'multiple-choice':
                        if (!state.shuffledOptions[state.currentQuestion]) {
                            state.shuffledOptions[state.currentQuestion] = shuffle([...question.options]);
                        }
                        html += '<div class="options">';
                        state.shuffledOptions[state.currentQuestion].forEach((option, index) => {
                            const selected = state.selectedAnswer === option ? ' selected' : '';
                            html += `<button type="button" class="option-button${selected}" data-index="${index}">${option}</button>`;
                        });
                        html += '</div>';
                        break;

                    case 'atom-builder':
                        const savedAnswer = state.selectedAnswer || {};
                        html += `
                            <div class="atom-builder">
                                <div class="atom-controls">
                                    <div>
                                        <label for="protons">Number of Protons:</label>
                                        <input type="number" id="protons" min="0" max="118" value="${savedAnswer.protons || ''}">
                                    </div>
                                    <div>
                                        <label for="neutrons">Number of Neutrons:</label>
                                        <input type="number" id="neutrons" min="0" max="200" value="${savedAnswer.neutrons || ''}">
                                    </div>
                                    <div>
                                        <label for="electrons">Number of Electrons:</label>
                                        <input type="number" id="electrons" min="0" max="118" value="${savedAnswer.electrons || ''}">
                                    </div>
                                </div>
                                <p class="atom-hint">Enter the correct number of protons, neutrons, and electrons for this atom.</p>
                            </div>
                        `;
                        break;
                }

                questionContainer.innerHTML = html;
                submitButton.style.display = 'block';
                nextButton.style.display = 'none';

                // Add event listeners for multiple choice questions
                if (question.type === 'multiple-choice') {
                    const optionsContainer = questionContainer.querySelector('.options');
                    if (optionsContainer) {
                        optionsContainer.addEventListener('click', function(e) {
                            if (state.answered) return;
                            const option = e.target.closest('.option-button');
                            if (!option) return;
                            const options = document.querySelectorAll('.option-button');
                            options.forEach(opt => opt.classList.remove('selected'));
                            option.classList.add('selected');
                            state.selectedAnswer = state.shuffledOptions[state.currentQuestion][parseInt(option.dataset.index)];
                        });
                    }
                } else if (question.type === 'atom-builder') {
                    const inputs = ['protons', 'neutrons', 'electrons'].map(id => document.getElementById(id));
                    inputs.forEach(input => {
                        input.addEventListener('input', () => {
                            if (state.answered) return;
                            state.selectedAnswer = {
                                protons: parseInt(inputs[0].value) || 0,
                                neutrons: parseInt(inputs[1].value) || 0,
                                electrons: parseInt(inputs[2].value) || 0
                            };
                        });
                    });
                }
            };

            // Check answer and provide feedback
            const checkAnswer = () => {
                if (state.answered) return;

                const question = questions[state.currentQuestion];
                const feedbackDiv = document.getElementById('feedback');
                let isCorrect = false;

                switch (question.type) {
                    case 'multiple-choice':
                        isCorrect = state.selectedAnswer === question.correctAnswer;
                        break;

                    case 'atom-builder':
                        const protons = parseInt(document.getElementById('protons').value) || 0;
                        const neutrons = parseInt(document.getElementById('neutrons').value) || 0;
                        const electrons = parseInt(document.getElementById('electrons').value) || 0;

                        state.selectedAnswer = {
                            protons: protons,
                            neutrons: neutrons,
                            electrons: electrons
                        };

                        isCorrect = protons === question.correctAnswer.protons &&
                                   neutrons === question.correctAnswer.neutrons &&
                                   electrons === question.correctAnswer.electrons;
                        break;
                }

                if (isCorrect) {
                    state.score++;
                    feedbackDiv.innerHTML = '<p class="correct">Correct!</p>';
                } else {
                    state.incorrectAnswers.push({
                        question: question.question,
                        type: question.type,
                        userAnswer: state.selectedAnswer || 'No answer provided',
                        correctAnswer: question.correctAnswer
                    });
                    feedbackDiv.innerHTML = '<p class="incorrect">Incorrect!</p>';
                }

                state.answered = true;
                submitButton.style.display = 'none';
                nextButton.style.display = 'block';
            };

            // Show final results
            const sendResultsEmail = async () => {
                const scorePercentage = (state.score / questions.length) * 100;
                let emailMessage = `Quiz Score: ${state.score} out of ${questions.length} (${scorePercentage.toFixed(1)}%)\nCompleted: ${new Date().toLocaleString()}\n\n`;

                if (state.incorrectAnswers.length > 0) {
                    emailMessage += '\nIncorrect Answers:\n';
                    state.incorrectAnswers.forEach((item, index) => {
                        emailMessage += `\nQuestion: ${item.question}\n`;
                        if (item.type === 'atom-builder') {
                            emailMessage += `   Your Answer: Protons=${item.userAnswer.protons}, Neutrons=${item.userAnswer.neutrons}, Electrons=${item.userAnswer.electrons}\n`;
                            emailMessage += `   Correct Answer: Protons=${item.correctAnswer.protons}, Neutrons=${item.correctAnswer.neutrons}, Electrons=${item.correctAnswer.electrons}\n`;
                        } else {
                            emailMessage += `   Your Answer: ${item.userAnswer}\n`;
                            emailMessage += `   Correct Answer: ${item.correctAnswer}\n`;
                        }
                    });
                }

                const templateParams = {
                    from_name: 'Physical Science Quiz System',
                    student_email: state.studentEmail,
                    to_name: 'Instructor',
                    subject: 'Physical Science Module 3 Quiz Results',
                    message: `Student Email: ${state.studentEmail}\n\n${emailMessage}`,
                    reply_to: state.studentEmail
                };

                try {
                    await emailjs.send(
                        'service_ot1jg6s',
                        'template_v678xjf',
                        templateParams
                    );
                    // Show success message
                    const emailStatus = document.getElementById('email-status');
                    emailStatus.textContent = 'Results sent to your email!';
                    emailStatus.style.color = '#28a745';
                    emailStatus.style.display = 'block';
                } catch (error) {
                    console.error('Failed to send email:', error);
                    // Show error message
                    const emailStatus = document.getElementById('email-status');
                    emailStatus.textContent = 'Failed to send results email. You can still download them below.';
                    emailStatus.style.color = '#dc3545';
                    emailStatus.style.display = 'block';
                }
            };

            const downloadResults = () => {
                const scorePercentage = (state.score / questions.length) * 100;
                let resultsText = `Module 3 Quiz Results\n`;
                resultsText += `Date: ${new Date().toLocaleString()}\n`;
                resultsText += `Score: ${state.score} out of ${questions.length} (${scorePercentage.toFixed(1)}%)\n\n`;

                if (state.incorrectAnswers.length > 0) {
                    resultsText += 'Incorrect Answers:\n';
                    state.incorrectAnswers.forEach((item, index) => {
                        resultsText += `\nQuestion: ${item.question}\n`;
                        if (item.type === 'atom-builder') {
                            resultsText += `Your Answer: Protons=${item.userAnswer.protons}, Neutrons=${item.userAnswer.neutrons}, Electrons=${item.userAnswer.electrons}\n`;
                            resultsText += `Correct Answer: Protons=${item.correctAnswer.protons}, Neutrons=${item.correctAnswer.neutrons}, Electrons=${item.correctAnswer.electrons}\n`;
                        } else {
                            resultsText += `Your Answer: ${item.userAnswer}\n`;
                            resultsText += `Correct Answer: ${item.correctAnswer}\n`;
                        }
                    });
                } else {
                    resultsText += '\nCongratulations! All answers were correct!';
                }

                const blob = new Blob([resultsText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `module3_quiz_results_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const restartQuiz = () => {
                emailContainer.style.display = 'block';
                quizContainer.style.display = 'none';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                emailInput.value = '';
                document.getElementById('save-results').checked = true;
            };

            const showResults = async () => {
                quizContainer.style.display = 'none';
                resultsDiv.style.display = 'block';
                submitButton.style.display = 'none';
                nextButton.style.display = 'none';
                
                // Send results via email if enabled
                if (state.saveResults) {
                    await sendResultsEmail();
                    const emailStatusDiv = document.getElementById('email-status');
                    emailStatusDiv.textContent = 'Results sent successfully!';
                    emailStatusDiv.style.display = 'block';
                }

                // Add event listeners for download and restart buttons
                document.getElementById('download-results').addEventListener('click', downloadResults);
                document.getElementById('restart-quiz').addEventListener('click', restartQuiz);

                const scorePercentage = (state.score / questions.length) * 100;
                const scoreDiv = document.getElementById('score');
                const incorrectAnswersDiv = document.getElementById('incorrect-answers');

                scoreDiv.innerHTML = `
                    <p>Your Score: ${state.score} out of ${questions.length} (${scorePercentage.toFixed(1)}%)</p>
                `;

                if (state.incorrectAnswers.length > 0) {
                    let incorrectHtml = '<h3>Review Incorrect Answers:</h3><ul class="incorrect-answers">';
                    state.incorrectAnswers.forEach(item => {
                        incorrectHtml += `
                            <li class="review-item">
                                <p><strong>Question:</strong> ${item.question}</p>
                                <p><strong>Your Answer:</strong> ${item.yourAnswer}</p>
                                <p><strong>Correct Answer:</strong> ${item.correctAnswer}</p>
                            </li>
                        `;
                    });
                    incorrectHtml += '</ul>';
                    incorrectAnswersDiv.innerHTML = incorrectHtml;

                    // Create downloadable results
                    const resultsText = `
                        Quiz Results for ${state.studentEmail}
                        Score: ${state.score} out of ${questions.length} (${scorePercentage.toFixed(1)}%)

                        Incorrect Answers:
                        ${state.incorrectAnswers.map(item => 
                            `Question: ${item.question}
Your Answer: ${item.yourAnswer}
Correct Answer: ${item.correctAnswer}
`
                        ).join('\n')}

                        Date: ${new Date().toLocaleString()}
                    `;

                    incorrectAnswersDiv.innerHTML += `<p class="review-note">Review these questions to improve your understanding.</p>`;
                } else {
                    incorrectAnswersDiv.innerHTML = '<p class="perfect-score">Perfect score! Great job!</p>';
                }
            };

            // Add event listeners
            submitButton.addEventListener('click', checkAnswer);
            nextButton.addEventListener('click', () => {
                state.answered = false;
                state.selectedAnswer = null;
                if (state.currentQuestion < questions.length - 1) {
                    state.currentQuestion++;
                    displayQuestion();
                } else {
                    showResults();
                }
            });
            startButton.addEventListener('click', () => {
                const email = emailInput.value.trim();
                const saveResults = document.getElementById('save-results').checked;

                if (saveResults && (!email || !email.includes('@'))) {
                    errorDiv.textContent = 'Please enter a valid email address to save results';
                    errorDiv.style.display = 'block';
                    return;
                } else {
                    state.studentEmail = email;
                    state.saveResults = saveResults;
                    state.currentQuestion = 0;
                    state.score = 0;
                    state.answered = false;
                    state.selectedAnswer = null;
                    state.shuffledOptions = {};
                    state.incorrectAnswers = [];
                    
                    const emailContainer = document.getElementById('email-container');
                    const quizContainer = document.getElementById('quiz-container');
                    emailContainer.style.display = 'none';
                    quizContainer.style.display = 'block';
                    errorDiv.style.display = 'none';
                    displayQuestion();
                }
                displayQuestion();
            });
        });
    </script>
</body>
</html>